<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°ì´íŠ¸ ìœ„í—˜ë„ ì˜ˆì¸¡ & MBTI ë§¤ì¹­</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans KR', sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .section {
      background: white;
      margin-bottom: 30px;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .section h2 {
      color: #ff6b6b;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 2px solid #ff6b6b;
      padding-bottom: 10px;
    }

    form {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #ff6b6b;
    }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 107, 107, 0.2);
    }

    .result-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f8f9fa;
    }

    .result-box h3 {
      color: #ff6b6b;
      margin-bottom: 10px;
    }

    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-text {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .mbti-result {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .mbti-result h3 {
      color: #2e7d32;
      margin-bottom: 15px;
    }

    .mbti-score {
      font-size: 2em;
      color: #2e7d32;
      text-align: center;
      margin: 20px 0;
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      
      .section {
        padding: 15px;
      }
      
      .header h1 {
        font-size: 1.5em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ë°ì´íŠ¸ ìœ„í—˜ë„ ì˜ˆì¸¡ & MBTI ë§¤ì¹­</h1>
      <p>ì•ˆì „í•˜ê³  ì¦ê±°ìš´ ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë‹¹ì‹ ì˜ íŒŒíŠ¸ë„ˆ</p>
    </div>

    <div class="section">
      <h2>ë°ì´íŠ¸ ìœ„í—˜ë„ ì˜ˆì¸¡ê¸°</h2>
      <form id="predict-form">
        <div class="form-group">
          <label>ë‚ ì§œ</label>
          <input type="date" id="date" name="date" min="" max="">
        </div>

        <div class="form-group">
          <label>ì•½ì†ì¥ì†Œ</label>
          <select name="gu" id="gu">
            <option>ê°•ë‚¨êµ¬</option>
            <option>ê°•ë™êµ¬</option>
            <option>ê°•ë¶êµ¬</option>
            <option>ê°•ì„œêµ¬</option>
            <option>ê´€ì•…êµ¬</option>
            <option>ê´‘ì§„êµ¬</option>
            <option>êµ¬ë¡œêµ¬</option>
            <option>ê¸ˆì²œêµ¬</option>
            <option>ë…¸ì›êµ¬</option>
            <option>ë„ë´‰êµ¬</option>
            <option>ë™ì‘êµ¬</option>
            <option>ë§ˆí¬êµ¬</option>
            <option>ì„œëŒ€ë¬¸êµ¬</option>
            <option>ì„œì´ˆêµ¬</option>
            <option>ì„±ë™êµ¬</option>
            <option>ì†¡íŒŒêµ¬</option>
            <option>ì–‘ì²œêµ¬</option>
            <option>ìš©ì‚°êµ¬</option>
            <option>ì€í‰êµ¬</option>
            <option>ì¢…ë¡œêµ¬</option>
            <option>ì¤‘êµ¬</option>
            <option>ì¤‘ë‘êµ¬</option>
          </select>
        </div>

        <div class="form-group">
          <label>MBTI</label>
          <select name="mbti">
            <option>INFP</option>
            <option>INFJ</option>
            <option>ISFP</option>
            <option>ISFJ</option>
            <option>INTP</option>
            <option>INTJ</option>
            <option>ISTP</option>
            <option>ISTJ</option>
            <option>ENFP</option>
            <option>ENFJ</option>
            <option>ESFP</option>
            <option>ESFJ</option>
            <option>ENTP</option>
            <option>ENTJ</option>
            <option>ESTP</option>
            <option>ESTJ</option>
          </select>
        </div>

        <input type="hidden" id="day" name="day">
        <input type="hidden" id="holiday" name="holiday">

        <button type="submit">ìœ„í—˜ë„ ì˜ˆì¸¡í•˜ê¸°</button>

        <div class="result-box">
          <div id="result"></div>
          <p id="weather-info"></p>
          <p id="day-message"></p>
        </div>

        <div class="form-group">
          <label>ì´ìš©í•  ì§€í•˜ì² ì—­</label>
          <input type="text" id="station" name="station" placeholder="ì—­ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" list="station-list" autocomplete="off">
          <datalist id="station-list"></datalist>
          <p class="info-text">ì—­ëª…ì„ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆŒëŸ¬ í˜¼ì¡ë„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <p id="subway-info"></p>
      </form>
    </div>

    <div class="section">
      <h2>MBTI ê¶í•© ë§¤ì¹­</h2>
      <form id="mbti-form" action="/mbti" method="POST">
        <div class="form-group">
          <label>ë‚´ MBTI</label>
          <select name="my_mbti" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option>INFP</option>
            <option>INFJ</option>
            <option>ISFP</option>
            <option>ISFJ</option>
            <option>INTP</option>
            <option>INTJ</option>
            <option>ISTP</option>
            <option>ISTJ</option>
            <option>ENFP</option>
            <option>ENFJ</option>
            <option>ESFP</option>
            <option>ESFJ</option>
            <option>ENTP</option>
            <option>ENTJ</option>
            <option>ESTP</option>
            <option>ESTJ</option>
          </select>
        </div>

        <div class="form-group">
          <label>ë‚´ ì„±ë³„</label>
          <select name="my_gender" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="MALE">ë‚¨ì„±</option>
            <option value="FEMALE">ì—¬ì„±</option>
          </select>
        </div>

        <div class="form-group">
          <label>ìƒëŒ€ë°© MBTI</label>
          <select name="their_mbti" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option>INFP</option>
            <option>INFJ</option>
            <option>ISFP</option>
            <option>ISFJ</option>
            <option>INTP</option>
            <option>INTJ</option>
            <option>ISTP</option>
            <option>ISTJ</option>
            <option>ENFP</option>
            <option>ENFJ</option>
            <option>ESFP</option>
            <option>ESFJ</option>
            <option>ENTP</option>
            <option>ENTJ</option>
            <option>ESTP</option>
            <option>ESTJ</option>
          </select>
        </div>

        <div class="form-group">
          <label>ìƒëŒ€ë°© ì„±ë³„</label>
          <select name="their_gender" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="MALE">ë‚¨ì„±</option>
            <option value="FEMALE">ì—¬ì„±</option>
          </select>
        </div>

        <button type="submit">ê¶í•© í™•ì¸í•˜ê¸°</button>
      </form>

      {% if show_mbti_result %}
      <div class="mbti-result">
        <h3>ê¶í•© ê²°ê³¼</h3>
        <div class="mbti-score">{{ mbti_success }}</div>
        <h3>ê¶í•© ì ìˆ˜: {{ mbti_success }} / 1.0</h3>
        {% if mbti_success >= 0.7 %}
          <p>â¤ï¸ ì •ë§ ì˜ ë§ëŠ” ê¶í•©ì´ì—ìš”!</p>
        {% elif mbti_success >= 0.5 %}
          <p>ğŸ˜Š ë¬´ë‚œí•œ ê¶í•©ì…ë‹ˆë‹¤.</p>
        {% else %}
          <p>ğŸ¤” ì•½ê°„ ë…¸ë ¥ í•„ìš”í•œ ì¡°í•©ì¼ ìˆ˜ë„ ìˆì–´ìš”.</p>
        {% endif %}
        <form id="feedback-form" action="/mbti/feedback" method="POST">
          <input type="hidden" name="my_mbti" value="{{ my_mbti }}">
          <input type="hidden" name="my_gender" value="{{ my_gender }}">
          <input type="hidden" name="their_mbti" value="{{ their_mbti }}">
          <input type="hidden" name="their_gender" value="{{ their_gender }}">
          <div class="form-group">
            <label>ì‹¤ì œ ë§Œë‚¨ì€ ì–´ë• ë‚˜ìš”?</label>
            <select name="success" required>
              <option value="5">ğŸ˜ ìµœê³ ì˜ˆìš”</option>
              <option value="4">ğŸ˜Š ê½¤ ì¢‹ì•„ìš”</option>
              <option value="3">ğŸ˜ ë³´í†µì´ì—ìš”</option>
              <option value="2">ğŸ˜• ë³„ë¡œì˜€ì–´ìš”</option>
              <option value="1">ğŸ˜¡ ìµœì•…ì´ì—ìš”</option>
            </select>
          </div>
          <button type="submit">í”¼ë“œë°± ì œì¶œí•˜ê¸°</button>
        </form>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 15px; width: 80%; max-width: 500px;">
      <h3 style="color: #ff6b6b; margin-bottom: 20px;">í”¼ë“œë°± ì œì¶œ ì™„ë£Œ</h3>
      <p style="margin-bottom: 20px;">ì†Œì¤‘í•œ í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤!</p>
      <button type="button" id="closeModalBtn" style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    // Set date input min and max values
    function setDateRange() {
      const today = new Date();
      const maxDate = new Date();
      maxDate.setDate(today.getDate() + 5); // 5 days from today

      // Format dates to YYYY-MM-DD
      const formatDate = (date) => {
        return date.toISOString().split('T')[0];
      };

      const dateInput = document.getElementById('date');
      dateInput.min = formatDate(today);
      dateInput.max = formatDate(maxDate);
    }

    // Call setDateRange when page loads
    window.onload = function() {
      setDateRange();
      // ... existing onload code ...
    };

    const holidayMap = {
      "02-14": "ë°œë Œíƒ€ì¸ë°ì´",
      "03-01": "ì‚¼ì¼ì ˆ",
      "05-05": "ì–´ë¦°ì´ë‚ ",
      "06-06": "í˜„ì¶©ì¼",
      "12-24": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì´ë¸Œ",
      "12-25": "í¬ë¦¬ìŠ¤ë§ˆìŠ¤"
    };

    function getDayName(dateStr) {
      const days = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"];
      const date = new Date(dateStr);
      return days[date.getDay()];
    }

    function getHoliday(dateStr) {
      const mmdd = dateStr.slice(5);
      return holidayMap[mmdd] || "ê¸°íƒ€";
    }

    document.getElementById("date").addEventListener("change", function () {
      const selectedDate = this.value;
      const dayName = getDayName(selectedDate);
      document.getElementById("day").value = dayName;
      document.getElementById("holiday").value = getHoliday(selectedDate);
    });

    document.getElementById("predict-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const data = {
        date: formData.get("date"),
        day: formData.get("day"),
        gu: formData.get("gu"),
        mbti: formData.get("mbti"),
        holiday: formData.get("holiday"),
      };

      const res = await fetch("/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      document.getElementById("day-message").innerText = `${data.day}ë‚  ì•½ì†ì´ ìˆìœ¼ì‹œêµ°ìš”!`;
      
      document.getElementById("result").innerText = result.grade
        ? `ì˜ˆì¸¡ ë“±ê¸‰: ${result.grade}`
        : `ì˜¤ë¥˜: ${result.error}`;

      if (result.weather && result.temperature !== undefined) {
        document.getElementById("weather-info").innerText =
          `ë‚ ì”¨: ${result.weather}, ì˜¨ë„: ${result.temperature}Â°C`;
      } else {
        document.getElementById("weather-info").innerText = "";
      }

      if (result.subway) {
        document.getElementById("subway-info").innerText = result.subway;
      } else {
        document.getElementById("subway-info").innerText = "";
      }
    });

    window.addEventListener("DOMContentLoaded", async () => {
      const res = await fetch("/stations");
      const result = await res.json();

      if (result.stations) {
        const datalist = document.getElementById("station-list");
        result.stations.forEach(station => {
          const option = document.createElement("option");
          option.value = station;
          datalist.appendChild(option);
        });
      }
    });

    document.getElementById("station").addEventListener("keydown", async function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        const station = this.value.trim();
        const day = document.getElementById("day").value;

        if (!station) return;

        const res = await fetch("/congestion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ station, day })
        });

        const result = await res.json();
        document.getElementById("subway-info").innerText = result.message || "ì •ë³´ ì—†ìŒ";
      }
    });

    // Add feedback form submission handler
    document.getElementById('feedback-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      try {
        const response = await fetch('/mbti/feedback', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          showModal();
          // Reset the form after successful submission
          this.reset();
        } else {
          console.error('Error submitting feedback');
        }
      } catch (error) {
        console.error('Error submitting feedback:', error);
      }
    });

    // Scroll to bottom when MBTI results are shown
    if (document.querySelector('.mbti-result')) {
      window.onload = function() {
        window.scrollTo(0, document.body.scrollHeight);
      };
    }

    function showModal() {
      document.getElementById('feedbackModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('feedbackModal').style.display = 'none';
      window.location.href = '/';  // Redirect to home page
    }

    // Add event listener for close button
    document.getElementById('closeModalBtn').addEventListener('click', function(e) {
      e.preventDefault();
      closeModal();
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('feedbackModal');
      if (event.target == modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>
